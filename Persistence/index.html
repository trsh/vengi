<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Martin Gerhardy">
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Persistence - vengi - voxel engine and its tools</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Persistence";
    var mkdocs_page_input_path = "Persistence.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/cpp.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

<meta property="og:type" content="website" />
<meta property="og:title" content="vengi - voxel engine and its tools - Persistence" />
<meta property="og:description" content="Voxel editor for linux windows and macosx" />
<meta property="og:url" content="None" />
<meta property="og:image" content="https://raw.githubusercontent.com/wiki/mgerhardy/vengi/images/voxedit-knight.png" />
<meta property="og:image:type" content="image/png" />

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@MartinGerhardy" />
<meta name="twitter:title" content="vengi - voxel engine and its tools - Persistence" />
<meta name="twitter:description" content="Voxel editor for linux windows and macosx" />
<meta name="twitter:image" content="https://raw.githubusercontent.com/wiki/mgerhardy/vengi/images/voxedit-knight.png" />

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> vengi - voxel engine and its tools</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Welcome to vengi</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../CHANGELOG/">Changelog</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Basics</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../Dependencies/">Dependencies</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Compilation/">Building</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Configuration/">Configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Formats/">Formats</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../LUAScript/">Scripting api</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Palette/">Palette</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">VoxConvert</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../voxconvert/Index/">About</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../voxconvert/Usage/">Usage</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../voxconvert/Configuration/">Configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../voxconvert/Examples/">Examples</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../voxconvert/Screenshots/">Screenshots</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">VoxEdit</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../voxedit/Index/">About</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../voxedit/Features/">Features</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../voxedit/Controls/">Controls</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../voxedit/Configuration/">Configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../voxedit/Screenshots/">Screenshots</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Thumbnailer</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../thumbnailer/Index/">About</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../thumbnailer/Examples/">Example</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Development</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../Basics/">Basic</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../VisualTests/">Visual Tests</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../ShaderTool/">Shader integration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../ComputeShaderTool/">Compute Shader integration</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Persistence</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#general">General</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#dbhandler">DBHandler</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#persistencemgr">PersistenceMgr</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#databasetool">Databasetool</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Animations/">Animations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Attributes/">Attributes</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Network/">Network</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../AIRemoteDebugger/">AI development</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../openworld/Index/">OpenWorld</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mapview/Index/">MapView</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">vengi - voxel engine and its tools</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Development &raquo;</li>
        
      
    
    <li>Persistence</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/mgerhardy/vengi/edit/master/docs/Persistence.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="persistence-layer">Persistence layer</h1>
<h2 id="general">General</h2>
<p>This module manages the persistence layer and provides drivers to talk to the database. Currently the only driver implemented is for postgresql.</p>
<p>The main class for doing database interaction is the <code>DBHandler</code>.</p>
<p>In order to generate models that represent the tables, you can use the <code>databasetool</code> to generate the models from metadata files.</p>
<p>A more high level class to manage updates is the <code>PersistenceMgr</code>. It collects dirty-marked models and performs a mass-delta-update via prepared statements. You should use this for e.g. player updates.</p>
<p>It's always a good idea to check out the unit tests to get an idea of the functionality of those classes.</p>
<h2 id="dbhandler">DBHandler</h2>
<p>You have to create the models with the <code>tbl</code> file and generate C++ classes with the <code>databasetool</code> (see existing <code>tables.tbl</code> file CMake integrations. Usually you put your classes into the C++ namespace
<code>db</code>. Once you have those models, you can use the generated getters and setters to prepare the model. This can now get send over to the <code>DBHandler</code>. There are methods to insert, update, count, delete
or select particular entries from tables via the model values.</p>
<p>Copying the Model class instance is no problem, it's fast. The stuff that is copied is only 32bytes at the moment.</p>
<h3>Create (and update) table</h3>
<pre><code class="cpp">_dbHandler-&gt;createOrUpdateTable(db::EventModel());
</code></pre>

<p>The persistence layer has automatic upgrading and downgrading support for your tables. By defining them in a <code>.tbl</code> file, the system is able to generate the needed <code>ALTER</code> statements to get to your desired state.</p>
<p>Workflow to update a table:</p>
<ul>
<li>Edit the <code>tbl</code> file</li>
<li>Run your build</li>
<li>Run the application</li>
<li>The table, constraint, sequence... is updated to the state that is defined in your code. This allows you to go back and forth in your commits to test things. <strong><em>But keep in mind that removing a column from a table can lead to data loss. Because re-adding it, doesn't remember the previous values of course.</em></strong></li>
</ul>
<h3>Select by condition</h3>
<pre><code class="cpp">_dbHandler-&gt;select(db::EventModel(), persistence::DBConditionOne(), [this] (db::EventModel&amp;&amp; model) {
  [...]
});
</code></pre>

<h3>Multiple search conditions</h3>
<pre><code class="cpp">const db::DBConditionTestModelEmail emailCond(&quot;a@b.c&quot;);
const db::DBConditionTestModelName nameCond(&quot;Foo Bar&quot;);
_dbHandler-&gt;select(db::TestModel(), persistence::DBConditionMultiple(true, {&amp;emailCond, &amp;nameCond})), [this] (db::TestModel&amp;&amp; model) {
  [...]
});
</code></pre>

<h2 id="persistencemgr">PersistenceMgr</h2>
<p>This class is responsible to submit chunks for accumulated database updates. If you e.g. collect an item and soon after collect another one, this class will sum the items up and only generate one sql statement, instead of two.</p>
<h2 id="databasetool">Databasetool</h2>
<h3>Table descriptions for the databasetool</h3>
<p>The databasetool binary will generate model files for the
table definitions given in <code>*.tbl</code> files. You can specify the fields,
the constraints and set an operator for dealing with conflict states (more
about that later).</p>
<p>To add a new <code>*.tbl</code> file to a module and automatically generate code
for that table definition, you have to add the following after your
cmake <code>add_library(${LIB} ${SRCS})</code> call:</p>
<pre><code class="cmake">generate_db_models(${LIB} ${CMAKE_CURRENT_SOURCE_DIR}/tables.tbl ExampleModels.h)
</code></pre>

<p><code>ExampleModels.h</code> specifies a single header where all generated table models
are put into.</p>
<p>The generated models can be used with the <code>DBHandler</code> from the <code>persistence</code> module.</p>
<h3>Example</h3>
<p>If no classname is specified, the table name will be used with <code>Model</code> as postfix.</p>
<p>Table <code>user</code> will be generated as <code>UserModel</code> class, if no other <code>classname</code> was
specified</p>
<p>All models will be put into a <code>db</code> namespace - even if you specify your own namespace. For more details, see the parameter description below.</p>
<pre><code class="c">table &lt;TABLENAME&gt; {
  classname &lt;STRING&gt; (overrides the automatically determined name)
  namespace &lt;STRING&gt; (c++ namespace where the class is put into)
  schema &lt;STRING&gt; (default is public)
  field &lt;FIELDNAME&gt; {
    type &lt;FIELDTYPE&gt; (default: string)
    notnull (optional)
    length &lt;LENGTH&gt; (optional)
    operator &lt;OPERATOR&gt; (default: set)
    lowercase (optional)
    default &lt;DEFAULTVALUE&gt; (optional)
  }
  constraints {
    &lt;FIELDNAME&gt; unique
    &lt;FIELDNAME&gt; index
    &lt;FIELDNAME&gt; primarykey
    &lt;FIELDNAME2&gt; primarykey
    &lt;FIELDNAME&gt; autoincrement
    (&lt;FIELD1&gt;, &lt;FIELD2&gt;) unique
    &lt;FIELDNAME&gt; foreignkey &lt;FOREIGNTABLE&gt; &lt;FOREIGNFIELD&gt;
  }
}
</code></pre>

<h3>table</h3>
<p>A definition starts with <code>table &lt;TABLENAME&gt;</code>. The body is enclosed by <code>{</code> and <code>}</code>.</p>
<h4>classname</h4>
<p>This can be used to override the auto generated class name. The auto generated class name is generated from the table name converted to UpperCamelCase. This converts a table name like <code>my_table</code> to <code>MyTable</code> or <code>mytable</code> to <code>Mytable</code>.</p>
<h4>namespace</h4>
<p>You specify a namespace in your table definition that is called <code>mynamespace</code>. The table is called <code>MyTable</code>. The resulting c++ class will live in <code>mynamespace::db::MyTable</code>. If you omit the namespace setting in your table definition, the class will live in <code>db::MyTable</code>.</p>
<h4>schema</h4>
<p>Specifies the schema name that should be used for the table.</p>
<h4>field</h4>
<p>A field describes a table column, the name, the type and so on. This block is enclosed by <code>{</code> and <code>}</code>.</p>
<h5>default</h5>
<p>The default value for the field.</p>
<h5>length</h5>
<p>Specifies the optional length of the field.</p>
<h5>notnull</h5>
<p>If this is specified, the field may not be null.</p>
<h5>operator</h5>
<p>The operator is taken into account when you execute an insert or
update statement and hit a unique key violation.</p>
<p>This can e.g. be used to increase or decrease points for particular keys.
The first time you normally perform an insert - and the following times
you will hit a key violation and thus perform the insert or update with
the operator specified. The default operator is <code>set</code>. See a full list
of valid operators below.</p>
<h6>Valid operators</h6>
<ul>
<li><code>set</code></li>
<li><code>add</code></li>
<li><code>subtract</code></li>
</ul>
<h5>lowercase</h5>
<p>Convert a string value to lowercase before entering it into the database. This may not be set for <code>password</code> types of course.</p>
<h5>type</h5>
<p>Valid field types</p>
<ul>
<li><code>password</code></li>
<li><code>string</code></li>
<li><code>text</code></li>
<li><code>int</code></li>
<li><code>long</code></li>
<li><code>timestamp</code></li>
<li><code>boolean</code></li>
<li><code>short</code></li>
<li><code>byte</code></li>
<li><code>blob</code></li>
</ul>
<h4>constraints</h4>
<p>Here you can specify foreign key constraints, auto increment values and so on. This block is enclosed by <code>{</code> and <code>}</code>.</p>
<p>See the example above for a list of supported constraints.</p>
<h3>Other notable features</h3>
<ul>
<li>Timestamps are handled in UTC.</li>
<li>When using <code>int</code> or <code>short</code> as a field type, there is also a setter configured that accepts enums.</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Animations/" class="btn btn-neutral float-right" title="Animations">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../ComputeShaderTool/" class="btn btn-neutral" title="Compute Shader integration"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/mgerhardy/vengi/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../ComputeShaderTool/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../Animations/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
